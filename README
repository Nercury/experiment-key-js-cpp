Major rewrite of key engine.
